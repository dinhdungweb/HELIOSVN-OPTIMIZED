{%- liquid
  assign heading_tag = "h2"
  if section.settings.heading_h1
    assign heading_tag = "h1"
  endif
-%}

{% if section.settings.mode != 'disabled' %}
  <section id="adv-popup-{{ section.id }}" class="adv-popup adv-popup--{{ section.settings.position }}"
           data-delay-seconds="{{ section.settings.popup_delay_seconds }}"
           data-dismiss-for-days="{{ section.settings.popup_dismiss_for_days }}"
           data-freeze-scroll="{{ section.settings.freeze_scroll }}"
           aria-hidden="true" role="dialog">

    <style>
      #adv-popup-{{ section.id }} { position: fixed; inset: 0; display: none; z-index: 99999; }
      #adv-popup-{{ section.id }}.is-open { display: block; }
      #adv-popup-{{ section.id }} .adv-popup__backdrop { position: absolute; inset: 0; background: {{ section.settings.overlay_color }}; backdrop-filter: blur({{ section.settings.overlay_blur }}px); }
      #adv-popup-{{ section.id }} .adv-popup__modal { position: relative; z-index: 2; max-width: 880px; margin: 5vh auto; background: {{ section.settings.modal_bg }}; color: {{ section.settings.modal_text }}; border-radius: 12px; overflow: hidden; box-shadow: 0 16px 40px rgba(0,0,0,.35); }
      #adv-popup-{{ section.id }} .adv-popup__inner { display: grid; grid-template-columns: 1fr; gap: 0; }
      #adv-popup-{{ section.id }} .adv-popup__media { min-height: 220px; }
      #adv-popup-{{ section.id }} .adv-popup__content { padding: 24px; }
      #adv-popup-{{ section.id }} .adv-popup__title-image { max-width: 100%; height: auto; display: block; margin: 0 auto 12px; }
      #adv-popup-{{ section.id }} .adv-popup__title { margin: 0 0 8px; font-size: {{ section.settings.title_size }}px; text-align: center; }
      #adv-popup-{{ section.id }} .adv-popup__desc { margin: 8px 0 16px; text-align: center; }
      #adv-popup-{{ section.id }} .adv-popup__cta { text-align: center; margin-top: 12px; }
      #adv-popup-{{ section.id }} .adv-popup__cta .button { display: inline-block; padding: 12px 18px; background: {{ section.settings.button_bg }}; color: {{ section.settings.button_text }}; border: none; border-radius: 8px; text-decoration: none; }
      #adv-popup-{{ section.id }} .adv-popup__close { position: absolute; top: 10px; right: 12px; z-index: 3; background: transparent; border: none; color: inherit; padding: 10px; cursor: pointer; }
      #adv-popup-{{ section.id }} .adv-popup__close svg { width: 22px; height: 22px; }
      @media(min-width: 768px) {
        #adv-popup-{{ section.id }} .adv-popup__inner { grid-template-columns: {% if section.settings.image != blank %}1fr 1fr{% else %}1fr{% endif %}; }
      }
    </style>

    <button class="adv-popup__close" aria-label="Đóng">
      {% render 'svg-close' %}
    </button>

    <div class="adv-popup__backdrop" data-close="true"></div>
    <div class="adv-popup__modal" role="document">
      <div class="adv-popup__inner">
        {% if section.settings.image %}
          <div class="adv-popup__media">
            {% render 'responsive-image', image: section.settings.image, cover: true %}
          </div>
        {% endif %}

        <div class="adv-popup__content">
          {% if section.settings.title_image %}
            <img class="adv-popup__title-image" src="{{ section.settings.title_image | image_url: width: section.settings.title_image_width }}" alt="{{ section.settings.title | escape }}">
          {% endif %}

          {% if section.settings.title != blank %}
            <{{ heading_tag }} class="adv-popup__title">{{ section.settings.title | escape }}</{{ heading_tag }}>
          {% endif %}

          {% if section.settings.text != blank %}
            <div class="adv-popup__desc rte">{{ section.settings.text }}</div>
          {% endif %}

          {% if section.settings.custom_form_html != blank %}
            <div class="adv-popup__form">{{ section.settings.custom_form_html }}</div>
          {% elsif section.settings.show_newsletter %}
            <div class="adv-popup__form">
              {% form 'customer', id: 'adv-popup-{{ section.id }}-form' %}
                {% if form.posted_successfully? %}
                  <p>{{ 'general.popup_section.success' | t }}</p>
                {% else %}
                  {% if form.errors %}
                    <div class="error">
                      {% for field in form.errors %}
                        <p class="error-message">{{ field | capitalize }} - {{ form.errors.messages[field] }}</p>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <input type="hidden" name="contact[tags]" value="prospect,newsletter" />
                  <input type="email" required name="contact[email]" placeholder="{{ 'general.popup_section.email_placeholder' | t }}" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;" />
                  <div class="adv-popup__cta">
                    <button class="button" type="submit">{{ 'general.popup_section.submit' | t }}</button>
                  </div>
                {% endif %}
              {% endform %}
            </div>
          {% endif %}

          {% if section.settings.button_label != blank and section.settings.button_link != blank %}
            <div class="adv-popup__cta">
              <a class="button" href="{{ section.settings.button_link }}"{% if section.settings.button_new_tab %} target="_blank" rel="noopener"{% endif %}>{{ section.settings.button_label }}</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      (function(){
        var el = document.getElementById('adv-popup-{{ section.id }}');
        if(!el) return;
        var delay = parseInt(el.getAttribute('data-delay-seconds')) || 5;
        var dismissDays = parseInt(el.getAttribute('data-dismiss-for-days')) || 30;
        var key = 'advPopupDismissed-{{ section.id }}';
        var now = Date.now();
        var msDays = dismissDays * 24 * 60 * 60 * 1000;
        var dismissedAt = parseInt(localStorage.getItem(key) || '0');

        function open(){
          el.classList.add('is-open');
          el.setAttribute('aria-hidden', 'false');
          if('{{ section.settings.freeze_scroll }}' === 'true') {
            document.documentElement.style.overflow = 'hidden';
          }
        }
        function close(){
          el.classList.remove('is-open');
          el.setAttribute('aria-hidden', 'true');
          document.documentElement.style.overflow = '';
        }

        el.addEventListener('click', function(e){
          if(e.target.matches('[data-close]') || e.target.closest('.adv-popup__close')){
            localStorage.setItem(key, String(Date.now()));
            close();
          }
        });

        var isTesting = {% if section.settings.mode == 'testing' %}true{% else %}false{% endif %};
        var shouldShow = isTesting || (dismissedAt === 0 || (now - dismissedAt) > msDays);

        {% if request.design_mode %}
          // Luôn hiển thị trong theme editor để dễ cấu hình
          open();
        {% else %}
          if(shouldShow){
            setTimeout(open, delay * 1000);
          }
        {% endif %}
      })();
    </script>
  </section>
{% endif %}

{% schema %}
{
  "name": "Popup nâng cao",
  "class": "section-advanced-popup",
  "settings": [
    {"type": "select", "id": "mode", "label": "Chế độ", "default": "enabled", "options": [
      {"value": "enabled", "label": "Bật"},
      {"value": "testing", "label": "Chế độ thử"},
      {"value": "disabled", "label": "Tắt"}
    ]},
    {"type": "range", "id": "popup_delay_seconds", "label": "Độ trễ hiển thị (giây)", "default": 5, "min": 0, "max": 60, "step": 1, "unit": "s"},
    {"type": "range", "id": "popup_dismiss_for_days", "label": "Số ngày ẩn sau khi đóng", "default": 30, "min": 1, "max": 90, "step": 1, "unit": "day"},
    {"type": "checkbox", "id": "freeze_scroll", "label": "Khóa cuộn khi mở", "default": false},
    {"type": "select", "id": "position", "label": "Vị trí", "default": "center", "options": [
      {"value": "center", "label": "Giữa"},
      {"value": "bottom-left", "label": "Góc trái dưới"},
      {"value": "bottom-right", "label": "Góc phải dưới"}
    ]},

    {"type": "color", "id": "overlay_color", "label": "Màu nền mờ", "default": "rgba(0,0,0,0.55)"},
    {"type": "range", "id": "overlay_blur", "label": "Độ mờ (blur)", "min": 0, "max": 12, "step": 1, "default": 0},
    {"type": "color", "id": "modal_bg", "label": "Màu nền modal", "default": "#111"},
    {"type": "color", "id": "modal_text", "label": "Màu chữ modal", "default": "#f2f2f2"},

    {"type": "image_picker", "id": "image", "label": "Ảnh bên (tuỳ chọn)"},
    {"type": "image_picker", "id": "title_image", "label": "Ảnh tiêu đề (tuỳ chọn)"},
    {"type": "range", "id": "title_image_width", "label": "Rộng ảnh tiêu đề (px)", "min": 100, "max": 1100, "step": 10, "default": 600},
    {"type": "text", "id": "title", "label": "Tiêu đề", "default": "Đăng ký nhận ưu đãi"},
    {"type": "range", "id": "title_size", "label": "Cỡ chữ tiêu đề (px)", "min": 14, "max": 48, "step": 1, "default": 24},
    {"type": "richtext", "id": "text", "label": "Mô tả", "default": "<p>Nhận thông tin và ưu đãi sớm nhất từ Helios.<\/p>"},

    {"type": "textarea", "id": "custom_form_html", "label": "Form HTML tuỳ chỉnh (dán mã nhúng)", "info": "Bạn có thể dán mã form từ dịch vụ bên ngoài. Nếu để trống sẽ dùng form newsletter mặc định."},
    {"type": "checkbox", "id": "show_newsletter", "label": "Hiển thị form newsletter mặc định", "default": true},

    {"type": "text", "id": "button_label", "label": "Nhãn nút", "default": "Khám phá ngay"},
    {"type": "url", "id": "button_link", "label": "Liên kết nút"},
    {"type": "checkbox", "id": "button_new_tab", "label": "Mở trong tab mới", "default": true},
    {"type": "color", "id": "button_bg", "label": "Màu nền nút", "default": "#fab320"},
    {"type": "color", "id": "button_text", "label": "Màu chữ nút", "default": "#000"},

    {"type": "checkbox", "id": "heading_h1", "label": "Dùng thẻ H1 cho tiêu đề", "default": false}
  ]
}
{% endschema %}